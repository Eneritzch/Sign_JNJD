{% extends 'base.html' %}
{% load static %}

{% block title %}Analítica - SignLang AI{% endblock %}

{% block content %}

<!-- Background Elements -->
<div class="gradient-bg"></div>
<div class="fixed inset-0 pointer-events-none overflow-hidden" style="z-index: 0;">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div class="container-fluid section-spacing">
    <!-- Header -->
    <header class="text-center mb-12">
        <h2 class="text-5xl md:text-7xl font-black mb-4 text-gray-900">
            Analítica <span class="gradient-text">Completa</span>
        </h2>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Métricas de entrenamiento y estadísticas de uso en tiempo real
        </p>
    </header>

    <!-- Selector de Modelo -->
    <div class="flex justify-center mb-8">
        <div class="inline-flex bg-white dark:bg-gray-800 rounded-xl p-1 shadow-lg border border-gray-200 dark:border-gray-700">
            <button id="staticModelBtn" class="model-tab active px-6 py-3 rounded-lg font-bold transition-all">
                <i class="fas fa-hand-paper mr-2"></i>Señas Estáticas
            </button>
            <button id="dynamicModelBtn" class="model-tab px-6 py-3 rounded-lg font-bold transition-all">
                <i class="fas fa-video mr-2"></i>Señas Dinámicas
            </button>
        </div>
    </div>

    <!-- SECCIÓN: SEÑAS ESTÁTICAS -->
    <div id="staticSection" class="model-section">
        <!-- KPIs Principales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Precisión Final</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-bullseye text-white"></i>
                    </div>
                </div>
                <p id="staticFinalAccuracy" class="text-4xl font-black text-blue-600 dark:text-blue-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Conjunto de validación</p>
            </div>
            
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Pérdida Final</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                </div>
                <p id="staticFinalLoss" class="text-4xl font-black text-purple-600 dark:text-purple-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Validación</p>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Épocas</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-layer-group text-white"></i>
                    </div>
                </div>
                <p id="staticTotalEpochs" class="text-4xl font-black text-green-600 dark:text-green-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Total de iteraciones</p>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Reconocimientos</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-white"></i>
                    </div>
                </div>
                <p id="staticTotalRecognitions" class="text-4xl font-black text-orange-600 dark:text-orange-400 mt-2">0</p>
                <p class="text-xs text-gray-500 mt-1">Uso en producción</p>
            </div>
        </div>

        <!-- Gráficos de Entrenamiento -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center space-x-2">
                        <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span>Precisión por Época</span>
                    </h3>
                    <span class="text-xs text-gray-500 font-semibold">Entrenamiento vs Validación</span>
                </div>
                <canvas id="staticAccuracyChart" class="w-full" style="max-height: 300px;"></canvas>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center space-x-2">
                        <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-area text-white"></i>
                        </div>
                        <span>Pérdida por Época</span>
                    </h3>
                    <span class="text-xs text-gray-500 font-semibold">Entrenamiento vs Validación</span>
                </div>
                <canvas id="staticLossChart" class="w-full" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Uso en Producción -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="recognition-card">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                    <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trophy text-white"></i>
                    </div>
                    <span>Top 10 Letras Reconocidas</span>
                </h3>
                <canvas id="staticUsageChart" style="max-height: 350px;"></canvas>
            </div>

            <div class="recognition-card">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                    <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-percent text-white"></i>
                    </div>
                    <span>Historial de Confianza</span>
                </h3>
                <canvas id="staticConfidenceChart" style="max-height: 350px;"></canvas>
                <div class="mt-4 grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Promedio</p>
                        <p id="staticAvgConfidence" class="text-2xl font-black text-blue-600">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Mínima</p>
                        <p id="staticMinConfidence" class="text-2xl font-black text-orange-600">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Máxima</p>
                        <p id="staticMaxConfidence" class="text-2xl font-black text-green-600">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles Técnicos -->
        <div class="recognition-card">
            <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                <span>Configuración del Modelo</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border border-blue-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Arquitectura</p>
                    <p class="text-xl font-black text-blue-700">MobileNetV2</p>
                    <p class="text-xs text-gray-500 mt-1">Transfer Learning</p>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Clases</p>
                    <p class="text-xl font-black text-purple-700">24 Letras</p>
                    <p class="text-xs text-gray-500 mt-1">A-Y (sin J)</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-4 border border-green-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Entrada</p>
                    <p class="text-xl font-black text-green-700">224x224x3</p>
                    <p class="text-xs text-gray-500 mt-1">RGB normalizado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN: SEÑAS DINÁMICAS -->
    <div id="dynamicSection" class="model-section hidden">
        <!-- KPIs Principales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Precisión Final</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-bullseye text-white"></i>
                    </div>
                </div>
                <p id="dynamicFinalAccuracy" class="text-4xl font-black text-blue-600 dark:text-blue-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Conjunto de validación</p>
            </div>
            
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Pérdida Final</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                </div>
                <p id="dynamicFinalLoss" class="text-4xl font-black text-purple-600 dark:text-purple-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Validación</p>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Épocas</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-layer-group text-white"></i>
                    </div>
                </div>
                <p id="dynamicTotalEpochs" class="text-4xl font-black text-green-600 dark:text-green-400 mt-2">--</p>
                <p class="text-xs text-gray-500 mt-1">Total de iteraciones</p>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold uppercase">Reconocimientos</p>
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-white"></i>
                    </div>
                </div>
                <p id="dynamicTotalRecognitions" class="text-4xl font-black text-orange-600 dark:text-orange-400 mt-2">0</p>
                <p class="text-xs text-gray-500 mt-1">Uso en producción</p>
            </div>
        </div>

        <!-- Gráficos de Entrenamiento -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="recognition-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center space-x-2">
                        <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span>Precisión por Época</span>
                    </h3>
                    <span class="text-xs text-gray-500 font-semibold">Entrenamiento vs Validación</span>
                </div>
                <canvas id="dynamicAccuracyChart" class="w-full" style="max-height: 300px;"></canvas>
            </div>

            <div class="recognition-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center space-x-2">
                        <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-area text-white"></i>
                        </div>
                        <span>Pérdida por Época</span>
                    </h3>
                    <span class="text-xs text-gray-500 font-semibold">Entrenamiento vs Validación</span>
                </div>
                <canvas id="dynamicLossChart" class="w-full" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Uso en Producción -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="recognition-card">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                    <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trophy text-white"></i>
                    </div>
                    <span>Top 10 Señas Reconocidas</span>
                </h3>
                <canvas id="dynamicUsageChart" style="max-height: 350px;"></canvas>
            </div>

            <div class="recognition-card">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                    <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-percent text-white"></i>
                    </div>
                    <span>Historial de Confianza</span>
                </h3>
                <canvas id="dynamicConfidenceChart" style="max-height: 350px;"></canvas>
                <div class="mt-4 grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Promedio</p>
                        <p id="dynamicAvgConfidence" class="text-2xl font-black text-blue-600">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Mínima</p>
                        <p id="dynamicMinConfidence" class="text-2xl font-black text-orange-600">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold">Máxima</p>
                        <p id="dynamicMaxConfidence" class="text-2xl font-black text-green-600">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles Técnicos -->
        <div class="recognition-card">
            <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center space-x-2">
                <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-cog text-white"></i>
                </div>
                <span>Configuración del Modelo</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border border-blue-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Arquitectura</p>
                    <p class="text-xl font-black text-blue-700">CNN + BiGRU</p>
                    <p class="text-xs text-gray-500 mt-1">Secuencias temporales</p>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Clases</p>
                    <p class="text-xl font-black text-purple-700">22 Señas</p>
                    <p class="text-xs text-gray-500 mt-1">Palabras y frases</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-4 border border-green-200">
                    <p class="text-xs font-bold text-gray-600 uppercase mb-1">Entrada</p>
                    <p class="text-xl font-black text-green-700">20x224x224x3</p>
                    <p class="text-xs text-gray-500 mt-1">Secuencia de frames</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // ============================================================================
    // DATOS DEL SERVIDOR
    // ============================================================================
    const staticHistory = {{ static_history|safe }};
    const dynamicHistory = {{ dynamic_history|safe }};

    // ============================================================================
    // CAMBIO DE VISTA
    // ============================================================================
    const staticModelBtn = document.getElementById('staticModelBtn');
    const dynamicModelBtn = document.getElementById('dynamicModelBtn');
    const staticSection = document.getElementById('staticSection');
    const dynamicSection = document.getElementById('dynamicSection');

    staticModelBtn.addEventListener('click', () => {
        staticModelBtn.classList.add('active');
        dynamicModelBtn.classList.remove('active');
        staticSection.classList.remove('hidden');
        dynamicSection.classList.add('hidden');
    });

    dynamicModelBtn.addEventListener('click', () => {
        dynamicModelBtn.classList.add('active');
        staticModelBtn.classList.remove('active');
        dynamicSection.classList.remove('hidden');
        staticSection.classList.add('hidden');
    });

    // ============================================================================
    // CARGAR ANALÍTICA ESTÁTICA
    // ============================================================================
    function loadStaticAnalytics() {
        if (!staticHistory || !staticHistory.accuracy) {
            console.warn('No hay historial de entrenamiento estático');
            return;
        }

        const epochs = staticHistory.accuracy.length;
        const finalAccuracy = (staticHistory.val_accuracy[epochs - 1] * 100).toFixed(2);
        const finalLoss = staticHistory.val_loss[epochs - 1].toFixed(4);

        document.getElementById('staticTotalEpochs').textContent = epochs;
        document.getElementById('staticFinalAccuracy').textContent = finalAccuracy + '%';
        document.getElementById('staticFinalLoss').textContent = finalLoss;

        // Gráfico de Precisión
        const ctxAcc = document.getElementById('staticAccuracyChart');
        new Chart(ctxAcc, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: staticHistory.accuracy.map(v => v * 100),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: staticHistory.val_accuracy.map(v => v * 100),
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        max: 100,
                        ticks: { callback: (val) => val + '%' }
                    },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });

        // Gráfico de Pérdida
        const ctxLoss = document.getElementById('staticLossChart');
        new Chart(ctxLoss, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: staticHistory.loss,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: staticHistory.val_loss,
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });
    }

    // ============================================================================
    // CARGAR ANALÍTICA DINÁMICA
    // ============================================================================
    function loadDynamicAnalytics() {
        if (!dynamicHistory || !dynamicHistory.accuracy) {
            console.warn('No hay historial de entrenamiento dinámico');
            return;
        }

        const epochs = dynamicHistory.accuracy.length;
        const finalAccuracy = (dynamicHistory.val_accuracy[epochs - 1] * 100).toFixed(2);
        const finalLoss = dynamicHistory.val_loss[epochs - 1].toFixed(4);

        document.getElementById('dynamicTotalEpochs').textContent = epochs;
        document.getElementById('dynamicFinalAccuracy').textContent = finalAccuracy + '%';
        document.getElementById('dynamicFinalLoss').textContent = finalLoss;

        // Gráfico de Precisión
        const ctxAcc = document.getElementById('dynamicAccuracyChart');
        new Chart(ctxAcc, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: dynamicHistory.accuracy.map(v => v * 100),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: dynamicHistory.val_accuracy.map(v => v * 100),
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        max: 100,
                        ticks: { callback: (val) => val + '%' }
                    },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });

        // Gráfico de Pérdida
        const ctxLoss = document.getElementById('dynamicLossChart');
        new Chart(ctxLoss, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: dynamicHistory.loss,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: dynamicHistory.val_loss,
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(4)}`
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });
    }

    // ============================================================================
    // CARGAR ESTADÍSTICAS DE USO
    // ============================================================================
    async function loadUsageStats(modelType) {
        try {
            const response = await fetch(`/dashboard/api/usage-stats/?model_type=${modelType}`);
            const data = await response.json();

            if (data.status === 'success') {
                const stats = data.data;

                // Actualizar KPIs
                const totalRecognitionsEl = document.getElementById(`${modelType}TotalRecognitions`);
                const avgConfidenceEl = document.getElementById(`${modelType}AvgConfidence`);
                const minConfidenceEl = document.getElementById(`${modelType}MinConfidence`);
                const maxConfidenceEl = document.getElementById(`${modelType}MaxConfidence`);

                if (totalRecognitionsEl) totalRecognitionsEl.textContent = stats.total_recognitions || 0;

                if (stats.confidence_history && stats.confidence_history.length > 0) {
                    const avg = (stats.confidence_history.reduce((a, b) => a + b, 0) / stats.confidence_history.length).toFixed(1);
                    const min = Math.min(...stats.confidence_history).toFixed(1);
                    const max = Math.max(...stats.confidence_history).toFixed(1);

                    if (avgConfidenceEl) avgConfidenceEl.textContent = avg + '%';
                    if (minConfidenceEl) minConfidenceEl.textContent = min + '%';
                    if (maxConfidenceEl) maxConfidenceEl.textContent = max + '%';
                } else {
                    if (avgConfidenceEl) avgConfidenceEl.textContent = '--';
                    if (minConfidenceEl) minConfidenceEl.textContent = '--';
                    if (maxConfidenceEl) maxConfidenceEl.textContent = '--';
                }

                // Gráfico de uso por clase (Top 10)
                const usageChartEl = document.getElementById(`${modelType}UsageChart`);
                if (usageChartEl && stats.by_class) {
                    const sortedClasses = Object.entries(stats.by_class)
                        .sort(([,a], [,b]) => b.count - a.count)
                        .slice(0, 10);

                    const labels = sortedClasses.map(([cls,]) => cls);
                    const counts = sortedClasses.map(([,data]) => data.count);

                    new Chart(usageChartEl, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Reconocimientos',
                                data: counts,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { precision: 0 }
                                }
                            }
                        }
                    });
                }

                // Gráfico de historial de confianza
                const confidenceChartEl = document.getElementById(`${modelType}ConfidenceChart`);
                if (confidenceChartEl && stats.confidence_history) {
                    new Chart(confidenceChartEl, {
                        type: 'line',
                        data: {
                            labels: stats.confidence_history.map((_, i) => i + 1),
                            datasets: [{
                                label: 'Confianza (%)',
                                data: stats.confidence_history,
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                borderWidth: 2,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { callback: (val) => val + '%' }
                                },
                                x: {
                                    title: { display: true, text: 'Últimas predicciones' }
                                }
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error(`Error loading ${modelType} usage stats:`, error);
        }
    }

    // ============================================================================
    // INICIALIZACIÓN
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadStaticAnalytics();
        loadDynamicAnalytics();
        loadUsageStats('static');
        loadUsageStats('dynamic');
    });
</script>

<style>
    .model-tab {
        color: #6b7280;
        background: transparent;
    }
    .model-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .model-section {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .recognition-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    .icon-box {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
    }
    .gradient-text {
        background: linear-gradient(90deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .gradient-bg {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.2), transparent 60%),
                    radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.2), transparent 60%);
        z-index: 0;
    }
    .orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
    }
    .orb-1 { width: 200px; height: 200px; background: #6366f1; top: 10%; left: 5%; }
    .orb-2 { width: 250px; height: 250px; background: #a855f7; bottom: 15%; right: 10%; }
    .orb-3 { width: 150px; height: 150px; background: #f59e0b; top: 40%; right: 20%; }
</style>

{% endblock %}