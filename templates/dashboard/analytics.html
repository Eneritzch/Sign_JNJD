{% extends 'base.html' %}
{% load static %}

{% block title %}Analítica{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
{% endblock %}

{% block content %}

<!-- Background Elements -->
<div class="gradient-bg"></div>
<div class="fixed inset-0 pointer-events-none overflow-hidden" style="z-index: 0;">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div class="container-fluid section-spacing">
    <!-- Header -->
    <header class="analytics-page-header">
        <h2 class="text-4xl md:text-6xl font-black mb-4 text-gray-900">
            Analítica <span class="gradient-text">Completa</span>
        </h2>
        <p class="analytics-page-subtitle">
            Métricas de entrenamiento y estadísticas de uso en tiempo real
        </p>
    </header>

    <!-- Selector de Modelo -->
    <div class="flex justify-center mb-8">
        <div class="analytics-model-selector">
            <button id="staticModelBtn" class="model-tab active">
                <i class="fas fa-hand-paper"></i>Señas Estáticas
            </button>
            <button id="dynamicModelBtn" class="model-tab">
                <i class="fas fa-video"></i>Señas Dinámicas
            </button>
        </div>
    </div>

    <!-- SECCIÓN: SEÑAS ESTÁTICAS -->
    <div id="staticSection" class="model-section">
        <!-- KPIs Principales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Precisión Final</p>
                    <div class="analytics-kpi-icon icon-accuracy">
                        <i class="fas fa-bullseye"></i>
                    </div>
                </div>
                <p id="staticFinalAccuracy" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Conjunto de validación</p>
            </div>
            
            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Pérdida Final</p>
                    <div class="analytics-kpi-icon icon-loss">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <p id="staticFinalLoss" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Validación</p>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Épocas</p>
                    <div class="analytics-kpi-icon icon-epochs">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
                <p id="staticTotalEpochs" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Total de iteraciones</p>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Reconocimientos</p>
                    <div class="analytics-kpi-icon icon-usage">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <p id="staticTotalRecognitions" class="analytics-kpi-value">0</p>
                <p class="analytics-kpi-subtitle">Uso en producción</p>
            </div>
        </div>

        <!-- Gráficos de Entrenamiento -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Precisión por Época</h3>
                    </div>
                </div>
                <canvas id="staticAccuracyChart" class="analytics-chart-canvas"></canvas>
            </div>

            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-chart-area"></i>
                        </div>
                        <h3>Pérdida por Época</h3>
                    </div>
                </div>
                <canvas id="staticLossChart" class="analytics-chart-canvas"></canvas>
            </div>
        </div>

        <!-- Uso en Producción -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h3>Top 5 Letras Reconocidas</h3>
                    </div>
                </div>
                <canvas id="staticUsageChart" class="analytics-chart-canvas" style="max-height: 350px;"></canvas>
            </div>

            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-percent"></i>
                        </div>
                        <h3>Historial de Confianza</h3>
                    </div>
                </div>
                <canvas id="staticConfidenceChart" class="analytics-chart-canvas" style="max-height: 350px;"></canvas>
                <div class="analytics-confidence-grid">
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Promedio</p>
                        <p id="staticAvgConfidence" class="analytics-confidence-stat-value stat-avg">--</p>
                    </div>
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Mínima</p>
                        <p id="staticMinConfidence" class="analytics-confidence-stat-value stat-min">--</p>
                    </div>
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Máxima</p>
                        <p id="staticMaxConfidence" class="analytics-confidence-stat-value stat-max">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles Técnicos -->
        <div class="analytics-tech-card">
            <div class="analytics-tech-header">
                <div class="analytics-tech-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h3>Configuración del Modelo</h3>
            </div>
            <div class="analytics-tech-grid">
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Arquitectura</p>
                    <p class="analytics-tech-item-value">MobileNetV2</p>
                    <p class="analytics-tech-item-desc">Transfer Learning</p>
                </div>
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Clases</p>
                    <p class="analytics-tech-item-value">24 Letras</p>
                    <p class="analytics-tech-item-desc">A-Y (sin J)</p>
                </div>
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Entrada</p>
                    <p class="analytics-tech-item-value">224x224x3</p>
                    <p class="analytics-tech-item-desc">RGB normalizado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN: SEÑAS DINÁMICAS -->
    <div id="dynamicSection" class="model-section hidden">
        <!-- KPIs Principales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Precisión Final</p>
                    <div class="analytics-kpi-icon icon-accuracy">
                        <i class="fas fa-bullseye"></i>
                    </div>
                </div>
                <p id="dynamicFinalAccuracy" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Conjunto de validación</p>
            </div>
            
            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Pérdida Final</p>
                    <div class="analytics-kpi-icon icon-loss">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <p id="dynamicFinalLoss" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Validación</p>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Épocas</p>
                    <div class="analytics-kpi-icon icon-epochs">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
                <p id="dynamicTotalEpochs" class="analytics-kpi-value">--</p>
                <p class="analytics-kpi-subtitle">Total de iteraciones</p>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <p class="analytics-kpi-label">Reconocimientos</p>
                    <div class="analytics-kpi-icon icon-usage">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <p id="dynamicTotalRecognitions" class="analytics-kpi-value">0</p>
                <p class="analytics-kpi-subtitle">Uso en producción</p>
            </div>
        </div>

        <!-- Gráficos de Entrenamiento -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Precisión por Época</h3>
                    </div>
                </div>
                <canvas id="dynamicAccuracyChart" class="analytics-chart-canvas"></canvas>
            </div>

            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-chart-area"></i>
                        </div>
                        <h3>Pérdida por Época</h3>
                    </div>
                </div>
                <canvas id="dynamicLossChart" class="analytics-chart-canvas"></canvas>
            </div>
        </div>

        <!-- Uso en Producción -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h3>Top 10 Señas Reconocidas</h3>
                    </div>
                </div>
                <canvas id="dynamicUsageChart" class="analytics-chart-canvas" style="max-height: 350px;"></canvas>
            </div>

            <div class="analytics-chart-card">
                <div class="analytics-chart-header">
                    <div class="analytics-chart-title">
                        <div class="analytics-chart-title-icon">
                            <i class="fas fa-percent"></i>
                        </div>
                        <h3>Historial de Confianza</h3>
                    </div>
                </div>
                <canvas id="dynamicConfidenceChart" class="analytics-chart-canvas" style="max-height: 350px;"></canvas>
                <div class="analytics-confidence-grid">
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Promedio</p>
                        <p id="dynamicAvgConfidence" class="analytics-confidence-stat-value stat-avg">--</p>
                    </div>
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Mínima</p>
                        <p id="dynamicMinConfidence" class="analytics-confidence-stat-value stat-min">--</p>
                    </div>
                    <div class="analytics-confidence-stat">
                        <p class="analytics-confidence-stat-label">Máxima</p>
                        <p id="dynamicMaxConfidence" class="analytics-confidence-stat-value stat-max">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles Técnicos -->
        <div class="analytics-tech-card">
            <div class="analytics-tech-header">
                <div class="analytics-tech-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h3>Configuración del Modelo</h3>
            </div>
            <div class="analytics-tech-grid">
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Arquitectura</p>
                    <p class="analytics-tech-item-value">CNN + BiGRU</p>
                    <p class="analytics-tech-item-desc">Secuencias temporales</p>
                </div>
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Clases</p>
                    <p class="analytics-tech-item-value">22 Señas</p>
                    <p class="analytics-tech-item-desc">Palabras y frases</p>
                </div>
                <div class="analytics-tech-item">
                    <p class="analytics-tech-item-label">Entrada</p>
                    <p class="analytics-tech-item-value">20x224x224x3</p>
                    <p class="analytics-tech-item-desc">Secuencia de frames</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // ============================================================================
    // DATOS DEL SERVIDOR
    // ============================================================================
    const staticHistory = {{ static_history|safe }};
    const dynamicHistory = {{ dynamic_history|safe }};

    // ============================================================================
    // CAMBIO DE VISTA
    // ============================================================================
    const staticModelBtn = document.getElementById('staticModelBtn');
    const dynamicModelBtn = document.getElementById('dynamicModelBtn');
    const staticSection = document.getElementById('staticSection');
    const dynamicSection = document.getElementById('dynamicSection');

    staticModelBtn.addEventListener('click', () => {
        staticModelBtn.classList.add('active');
        dynamicModelBtn.classList.remove('active');
        staticSection.classList.remove('hidden');
        dynamicSection.classList.add('hidden');
    });

    dynamicModelBtn.addEventListener('click', () => {
        dynamicModelBtn.classList.add('active');
        staticModelBtn.classList.remove('active');
        dynamicSection.classList.remove('hidden');
        staticSection.classList.add('hidden');
    });

    // ============================================================================
    // CARGAR ANALÍTICA ESTÁTICA
    // ============================================================================
    function loadStaticAnalytics() {
        if (!staticHistory || !staticHistory.accuracy) {
            console.warn('No hay historial de entrenamiento estático');
            return;
        }

        const epochs = staticHistory.accuracy.length;
        const finalAccuracy = (staticHistory.val_accuracy[epochs - 1] * 100).toFixed(2);
        const finalLoss = staticHistory.val_loss[epochs - 1].toFixed(4);

        document.getElementById('staticTotalEpochs').textContent = epochs;
        document.getElementById('staticFinalAccuracy').textContent = finalAccuracy + '%';
        document.getElementById('staticFinalLoss').textContent = finalLoss;

        // Gráfico de Precisión
        const ctxAcc = document.getElementById('staticAccuracyChart');
        new Chart(ctxAcc, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: staticHistory.accuracy.map(v => v * 100),
                        borderColor: '#415E72',
                        backgroundColor: 'rgba(65, 94, 114, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: staticHistory.val_accuracy.map(v => v * 100),
                        borderColor: '#baa4cb',
                        backgroundColor: 'rgba(186, 164, 203, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        max: 100,
                        ticks: { callback: (val) => val + '%' }
                    },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });

        // Gráfico de Pérdida
        const ctxLoss = document.getElementById('staticLossChart');
        new Chart(ctxLoss, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: staticHistory.loss,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: staticHistory.val_loss,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });
    }

    // ============================================================================
    // CARGAR ANALÍTICA DINÁMICA
    // ============================================================================
    function loadDynamicAnalytics() {
        if (!dynamicHistory || !dynamicHistory.accuracy) {
            console.warn('No hay historial de entrenamiento dinámico');
            return;
        }

        const epochs = dynamicHistory.accuracy.length;
        const finalAccuracy = (dynamicHistory.val_accuracy[epochs - 1] * 100).toFixed(2);
        const finalLoss = dynamicHistory.val_loss[epochs - 1].toFixed(4);

        document.getElementById('dynamicTotalEpochs').textContent = epochs;
        document.getElementById('dynamicFinalAccuracy').textContent = finalAccuracy + '%';
        document.getElementById('dynamicFinalLoss').textContent = finalLoss;

        // Gráfico de Precisión
        const ctxAcc = document.getElementById('dynamicAccuracyChart');
        new Chart(ctxAcc, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: dynamicHistory.accuracy.map(v => v * 100),
                        borderColor: '#415E72',
                        backgroundColor: 'rgba(65, 94, 114, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: dynamicHistory.val_accuracy.map(v => v * 100),
                        borderColor: '#baa4cb',
                        backgroundColor: 'rgba(186, 164, 203, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        max: 100,
                        ticks: { callback: (val) => val + '%' }
                    },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });

        // Gráfico de Pérdida
        const ctxLoss = document.getElementById('dynamicLossChart');
        new Chart(ctxLoss, {
            type: 'line',
            data: {
                labels: Array.from({length: epochs}, (_, i) => i + 1),
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: dynamicHistory.loss,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    },
                    {
                        label: 'Validación',
                        data: dynamicHistory.val_loss,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true },
                    x: { title: { display: true, text: 'Época' } }
                }
            }
        });
    }

    // ============================================================================
    // CARGAR ESTADÍSTICAS DE USO
    // ============================================================================
    async function loadUsageStats(modelType) {
        try {
            const response = await fetch(`/dashboard/api/usage-stats/?model_type=${modelType}`);
            const data = await response.json();

            if (data.status === 'success') {
                const stats = data.data;

                // Actualizar KPIs
                const totalRecognitionsEl = document.getElementById(`${modelType}TotalRecognitions`);
                const avgConfidenceEl = document.getElementById(`${modelType}AvgConfidence`);
                const minConfidenceEl = document.getElementById(`${modelType}MinConfidence`);
                const maxConfidenceEl = document.getElementById(`${modelType}MaxConfidence`);

                if (totalRecognitionsEl) totalRecognitionsEl.textContent = stats.total_recognitions || 0;

                if (stats.confidence_history && stats.confidence_history.length > 0) {
                    const avg = (stats.confidence_history.reduce((a, b) => a + b, 0) / stats.confidence_history.length).toFixed(1);
                    const min = Math.min(...stats.confidence_history).toFixed(1);
                    const max = Math.max(...stats.confidence_history).toFixed(1);

                    if (avgConfidenceEl) avgConfidenceEl.textContent = avg + '%';
                    if (minConfidenceEl) minConfidenceEl.textContent = min + '%';
                    if (maxConfidenceEl) maxConfidenceEl.textContent = max + '%';
                } else {
                    if (avgConfidenceEl) avgConfidenceEl.textContent = '--';
                    if (minConfidenceEl) minConfidenceEl.textContent = '--';
                    if (maxConfidenceEl) maxConfidenceEl.textContent = '--';
                }

                // Gráfico de uso por clase (Top 5)
                const usageChartEl = document.getElementById(`${modelType}UsageChart`);
                if (usageChartEl && stats.by_class) {
                    const sortedClasses = Object.entries(stats.by_class)
                        .sort(([,a], [,b]) => b.count - a.count)
                        .slice(0, 5);

                    const labels = sortedClasses.map(([cls,]) => cls);
                    const counts = sortedClasses.map(([,data]) => data.count);

                    new Chart(usageChartEl, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Reconocimientos',
                                data: counts,
                                backgroundColor: 'rgba(186, 164, 203, 0.8)',
                                borderColor: '#baa4cb',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { precision: 0 }
                                }
                            }
                        }
                    });
                }

                // Gráfico de historial de confianza
                const confidenceChartEl = document.getElementById(`${modelType}ConfidenceChart`);
                if (confidenceChartEl && stats.confidence_history) {
                    new Chart(confidenceChartEl, {
                        type: 'line',
                        data: {
                            labels: stats.confidence_history.map((_, i) => i + 1),
                            datasets: [{
                                label: 'Confianza (%)',
                                data: stats.confidence_history,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                borderWidth: 2,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { callback: (val) => val + '%' }
                                },
                                x: {
                                    title: { display: true, text: 'Últimas predicciones' }
                                }
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error(`Error loading ${modelType} usage stats:`, error);
        }
    }

    // ============================================================================
    // INICIALIZACIÓN
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadStaticAnalytics();
        loadDynamicAnalytics();
        loadUsageStats('static');
        loadUsageStats('dynamic');
    });
</script>

{% endblock %}