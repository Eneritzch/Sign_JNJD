{% extends 'base.html' %}
{% load static %}

{% block title %}Reconocimiento por Foto - SignLang AI{% endblock %}

{% block content %}

<!-- Background Elements -->
<div class="gradient-bg"></div>
<div class="fixed inset-0 pointer-events-none overflow-hidden" style="z-index: 0;">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div class="container-fluid section-spacing">
    <!-- Header -->
    <header class="text-center mb-12">
        <h2 class="text-5xl md:text-7xl font-black mb-4 text-gray-900">
            Captura tu <span class="gradient-text">Seña LSM</span>
        </h2>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Sistema optimizado: captura una foto de tu seña y obtén el resultado al instante
        </p>
    </header>

    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Panel Principal: Cámara/Foto -->
        <div class="lg:col-span-2">
            <div class="recognition-card">
                <!-- Contenedor de Video/Foto -->
                <div class="video-container aspect-video mb-6">
                    <!-- Video en vivo -->
                    <video id="video" class="w-full h-full object-cover" playsinline autoplay></video>
                    
                    <!-- Canvas para dibujar detección de manos -->
                    <canvas id="handCanvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                    
                    <!-- Canvas oculto para captura -->
                    <canvas id="captureCanvas" class="hidden"></canvas>
                    
                    <!-- Overlay cuando cámara está apagada -->
                    <div id="cameraOverlay" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center text-white px-6">
                            <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-white/30">
                                <i class="fas fa-camera text-white text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-3">Cámara Desactivada</h3>
                            <p class="text-white/80 mb-6">Inicia la cámara para comenzar</p>
                        </div>
                    </div>

                    <!-- Indicador de mano detectada - Mejorado -->
                    <div id="handDetected" class="hidden absolute top-4 right-4 hand-detected-badge">
                        <span class="pulse-dot"></span>
                        <span>MANO DETECTADA</span>
                    </div>

                    <!-- Contador de fotos -->
                    <div class="absolute top-4 left-4 detection-badge flex items-center space-x-2">
                        <i class="fas fa-camera"></i>
                        <span id="photoCount">0 fotos</span>
                    </div>

                    <!-- Indicador de zoom activo -->
                    <div id="zoomIndicator" class="hidden absolute bottom-4 left-4 zoom-indicator">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom: Solo Mano</span>
                    </div>
                </div>

                <!-- Controles -->
                <div id="cameraControls" class="space-y-4">
                    <!-- Botón Iniciar/Detener Cámara -->
                    <button id="toggleCameraBtn" class="w-full btn-camera-start text-white font-bold py-4 px-8 rounded-xl flex items-center justify-center space-x-3 transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-play text-xl"></i>
                        <span class="text-lg">Iniciar Cámara</span>
                    </button>

                    <!-- Botón Capturar (solo visible cuando cámara está activa) -->
                    <button id="captureBtn" class="hidden w-full btn-capture-photo flex items-center justify-center space-x-3 transition-all transform hover:scale-105">
                        <i class="fas fa-camera text-xl"></i>
                        <span class="text-lg">Capturar Foto de Mano</span>
                    </button>
                </div>

                <!-- Panel de foto capturada (oculto inicialmente) -->
                <div id="photoPanel" class="hidden space-y-4 mt-6">
                    <div class="recognition-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800 text-lg flex items-center space-x-2">
                                <div class="icon-box w-10 h-10 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-image text-white"></i>
                                </div>
                                <span>Foto Capturada (Solo Mano)</span>
                            </h3>
                            <button id="restartBtn" class="cta-secondary py-2 px-4 rounded-lg transition-all transform hover:scale-105 flex items-center space-x-2">
                                <i class="fas fa-redo"></i>
                                <span>Nueva Foto</span>
                            </button>
                        </div>
                        
                        <!-- Preview de foto con tamaño fijo y centrado -->
                        <div class="flex justify-center mb-4">
                            <div class="photo-preview-container">
                                <img id="photoPreview" src="" alt="Foto capturada">
                                <div class="badge-cropped">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Recortada</span>
                                </div>
                            </div>
                        </div>

                        <!-- Botón Reconocer -->
                        <button id="recognizeBtn" class="w-full cta-primary text-white font-bold py-4 px-8 rounded-xl flex items-center justify-center space-x-3 transition-all transform hover:scale-105 shadow-lg">
                            <i class="fas fa-brain text-xl"></i>
                            <span class="text-lg">Reconocer Seña</span>
                        </button>

                        <!-- Indicador de carga -->
                        <div id="loadingIndicator" class="hidden mt-4 text-center">
                            <div class="loading-spinner"></div>
                            <p class="text-gray-600 mt-2 font-semibold">Analizando seña con IA...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Lateral: Resultados y Stats -->
        <div class="space-y-6">
            <!-- Resultado del Reconocimiento -->
            <div id="resultPanel" class="hidden prediction-display">
                <div class="text-center relative z-10">
                    <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-check text-white text-3xl"></i>
                    </div>
                    <h3 class="font-black text-white text-2xl mb-3">Resultado</h3>
                    
                    <!-- Letra detectada -->
                    <div class="bg-white rounded-2xl p-8 mb-4">
                        <p class="text-sm text-gray-600 mb-2 font-semibold uppercase">Letra Detectada</p>
                        <p id="detectedLetter" class="percentage-badge text-purple-700">A</p>
                        <div class="flex items-center justify-center space-x-2 mt-4">
                            <div class="bg-green-500 rounded-full px-4 py-2">
                                <span id="mainConfidence" class="text-white font-bold">95.3%</span>
                            </div>
                            <span class="text-gray-600 font-semibold">confianza</span>
                        </div>
                    </div>

                    <!-- Top 3 predicciones -->
                    <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-3">Top 3 Predicciones</p>
                        <div id="top3Container" class="space-y-2">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="stat-mini">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-camera text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Estado Cámara</p>
                        <p id="cameraStatus" class="text-xl font-black text-gray-900">Inactiva</p>
                    </div>
                </div>
            </div>

            <div class="stat-mini">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Reconocimientos</p>
                        <p id="recognitionCount" class="text-xl font-black text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="stat-mini">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-leaf text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Modo</p>
                        <p class="text-xl font-black text-green-600">Eficiente</p>
                    </div>
                </div>
            </div>

            <!-- Instrucciones -->
            <div class="instructions-box">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="icon-box">
                        <i class="fas fa-lightbulb text-white"></i>
                    </div>
                    <h3 class="font-black text-gray-900 text-lg">Cómo Usar</h3>
                </div>
                <ol class="space-y-3">
                    <li class="flex items-start space-x-3">
                        <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 font-bold text-sm">1</div>
                        <span class="text-sm text-gray-700">Inicia la cámara y posiciona tu mano frente a ella</span>
                    </li>
                    <li class="flex items-start space-x-3">
                        <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 font-bold text-sm">2</div>
                        <span class="text-sm text-gray-700">Espera a que se detecte tu mano (indicador verde)</span>
                    </li>
                    <li class="flex items-start space-x-3">
                        <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 font-bold text-sm">3</div>
                        <span class="text-sm text-gray-700"><strong>La foto se recortará</strong> mostrando solo tu mano automáticamente</span>
                    </li>
                    <li class="flex items-start space-x-3">
                        <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 font-bold text-sm">4</div>
                        <span class="text-sm text-gray-700">Dale click a "Reconocer Seña" para obtener el resultado</span>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>

<script>
    // ============================================================================
    // ELEMENTOS DOM
    // ============================================================================
    const video = document.getElementById('video');
    const handCanvas = document.getElementById('handCanvas');
    const captureCanvas = document.getElementById('captureCanvas');
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    const recognizeBtn = document.getElementById('recognizeBtn');
    const restartBtn = document.getElementById('restartBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const photoPanel = document.getElementById('photoPanel');
    const photoPreview = document.getElementById('photoPreview');
    const resultPanel = document.getElementById('resultPanel');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const handDetected = document.getElementById('handDetected');
    const zoomIndicator = document.getElementById('zoomIndicator');

    const handCtx = handCanvas.getContext('2d');
    const captureCtx = captureCanvas.getContext('2d');

    // ============================================================================
    // ESTADO
    // ============================================================================
    let cameraActive = false;
    let stream = null;
    let hands = null;
    let rafId = null;
    let handIsVisible = false;
    let photosCaptured = 0;
    let recognitionsCount = 0;
    let capturedPhotoData = null;
    let lastHandBounds = null; // Para guardar la última posición de la mano

    // ============================================================================
    // MEDIAPIPE HANDS
    // ============================================================================
    function initMediaPipe() {
        hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onHandsResults);
    }

    // ============================================================================
    // CALLBACK DE MEDIAPIPE - GUARDAR POSICIÓN DE MANO
    // ============================================================================
    function onHandsResults(results) {
        if (!cameraActive) return;

        const rect = video.getBoundingClientRect();
        handCanvas.width = rect.width;
        handCanvas.height = rect.height;

        handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            handIsVisible = true;
            handDetected.classList.remove('hidden');
            zoomIndicator.classList.remove('hidden');

            const landmarks = results.multiHandLandmarks[0];

            // Calcular bounding box de la mano
            let minX = 1, minY = 1, maxX = 0, maxY = 0;
            for (const lm of landmarks) {
                minX = Math.min(minX, lm.x);
                minY = Math.min(minY, lm.y);
                maxX = Math.max(maxX, lm.x);
                maxY = Math.max(maxY, lm.y);
            }

            // Agregar margen (15%) y guardar bounds
            const padding = 0.15;
            const width = maxX - minX;
            const height = maxY - minY;
            
            lastHandBounds = {
                x: Math.max(0, minX - width * padding),
                y: Math.max(0, minY - height * padding),
                width: Math.min(1, width * (1 + 2 * padding)),
                height: Math.min(1, height * (1 + 2 * padding))
            };

            // Dibujar rectángulo de recorte
            handCtx.strokeStyle = '#00ff88';
            handCtx.lineWidth = 3;
            handCtx.strokeRect(
                lastHandBounds.x * handCanvas.width,
                lastHandBounds.y * handCanvas.height,
                lastHandBounds.width * handCanvas.width,
                lastHandBounds.height * handCanvas.height
            );

            // Dibujar conexiones de la mano
            const connections = [
                [0,1],[1,2],[2,3],[3,4],
                [0,5],[5,6],[6,7],[7,8],
                [5,9],[9,10],[10,11],[11,12],
                [9,13],[13,14],[14,15],[15,16],
                [13,17],[17,18],[18,19],[19,20],
                [0,17]
            ];

            handCtx.strokeStyle = '#00ffcc';
            handCtx.lineWidth = 2;
            handCtx.beginPath();
            
            for (const [start, end] of connections) {
                const startLm = landmarks[start];
                const endLm = landmarks[end];
                handCtx.moveTo(startLm.x * handCanvas.width, startLm.y * handCanvas.height);
                handCtx.lineTo(endLm.x * handCanvas.width, endLm.y * handCanvas.height);
            }
            handCtx.stroke();

            // Dibujar puntos
            for (const lm of landmarks) {
                handCtx.fillStyle = '#ffff00';
                handCtx.beginPath();
                handCtx.arc(lm.x * handCanvas.width, lm.y * handCanvas.height, 4, 0, Math.PI * 2);
                handCtx.fill();
            }
        } else {
            handIsVisible = false;
            handDetected.classList.add('hidden');
            zoomIndicator.classList.add('hidden');
            lastHandBounds = null;
        }
    }

    // ============================================================================
    // PROCESAR FRAMES
    // ============================================================================
    async function processFrame() {
        if (cameraActive && hands) {
            try {
                await hands.send({ image: video });
            } catch (e) {
                console.error('Error en MediaPipe:', e);
            }
        }
        rafId = requestAnimationFrame(processFrame);
    }

    // ============================================================================
    // INICIAR/DETENER CÁMARA
    // ============================================================================
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });

            video.srcObject = stream;
            await new Promise(resolve => {
                if (video.readyState >= 2) return resolve();
                video.onloadedmetadata = resolve;
            });

            cameraActive = true;
            initMediaPipe();
            processFrame();

            cameraOverlay.classList.add('hidden');
            toggleCameraBtn.innerHTML = '<i class="fas fa-stop text-xl"></i><span class="text-lg">Detener Cámara</span>';
            toggleCameraBtn.classList.remove('btn-camera-start');
            toggleCameraBtn.classList.add('btn-camera-stop');
            captureBtn.classList.remove('hidden');
            document.getElementById('cameraStatus').textContent = 'Activa';

        } catch (err) {
            console.error('Error de cámara:', err);
            alert('No se pudo acceder a la cámara. Verifica los permisos.');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        cameraActive = false;
        if (rafId) cancelAnimationFrame(rafId);

        cameraOverlay.classList.remove('hidden');
        toggleCameraBtn.innerHTML = '<i class="fas fa-play text-xl"></i><span class="text-lg">Iniciar Cámara</span>';
        toggleCameraBtn.classList.add('btn-camera-start');
        toggleCameraBtn.classList.remove('btn-camera-stop');
        captureBtn.classList.add('hidden');
        handDetected.classList.add('hidden');
        zoomIndicator.classList.add('hidden');
        document.getElementById('cameraStatus').textContent = 'Inactiva';
        lastHandBounds = null;
    }

    // ============================================================================
    // CAPTURAR FOTO CON ZOOM A LA MANO
    // ============================================================================
    function capturePhoto() {
        if (!cameraActive) return;

        // Verificar que hay una mano detectada
        if (!lastHandBounds) {
            alert('⚠️ No se detectó ninguna mano. Asegúrate de que tu mano esté visible.');
            return;
        }

        // Efecto de flash al capturar
        const flash = document.createElement('div');
        flash.className = 'capture-flash';
        video.parentElement.appendChild(flash);
        setTimeout(() => flash.remove(), 300);

        // Capturar frame completo
        captureCanvas.width = video.videoWidth || 640;
        captureCanvas.height = video.videoHeight || 480;
        captureCtx.drawImage(video, 0, 0);

        // Recortar región de la mano
        const cropX = lastHandBounds.x * captureCanvas.width;
        const cropY = lastHandBounds.y * captureCanvas.height;
        const cropWidth = lastHandBounds.width * captureCanvas.width;
        const cropHeight = lastHandBounds.height * captureCanvas.height;

        // Crear canvas temporal para el recorte
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = cropWidth;
        croppedCanvas.height = cropHeight;
        const croppedCtx = croppedCanvas.getContext('2d');

        // Copiar región de la mano
        croppedCtx.drawImage(
            captureCanvas,
            cropX, cropY, cropWidth, cropHeight,
            0, 0, cropWidth, cropHeight
        );

        // Convertir a base64
        capturedPhotoData = croppedCanvas.toDataURL('image/jpeg', 0.95);

        // Mostrar preview
        photoPreview.src = capturedPhotoData;
        
        // Actualizar UI
        photoPanel.classList.remove('hidden');
        resultPanel.classList.add('hidden');
        document.getElementById('cameraControls').classList.add('hidden');
        
        photosCaptured++;
        document.getElementById('photoCount').textContent = `${photosCaptured} foto${photosCaptured !== 1 ? 's' : ''}`;

        // Detener cámara
        stopCamera();
    }

    // ============================================================================
    // RECONOCER SEÑA
    // ============================================================================
    async function recognizeSign() {
        if (!capturedPhotoData) return;

        loadingIndicator.classList.remove('hidden');
        recognizeBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('photo', capturedPhotoData);

            const response = await fetch("{% url 'recognition:recognize_photo' %}", {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                // Mostrar resultado
                document.getElementById('detectedLetter').textContent = result.class;
                document.getElementById('mainConfidence').textContent = `${result.confidence}%`;

                // Top 3
                const top3Container = document.getElementById('top3Container');
                top3Container.innerHTML = result.top3.map((item, idx) => `
                    <div class="prediction-item ${idx === 0 ? 'first-place' : ''}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-bold text-gray-400">#${idx + 1}</span>
                                <span class="font-black text-lg text-gray-800">${item.letra}</span>
                            </div>
                            <span class="text-sm font-bold ${idx === 0 ? 'text-green-600' : 'text-gray-500'}">${item.confianza}%</span>
                        </div>
                    </div>
                `).join('');

                resultPanel.classList.remove('hidden');
                recognitionsCount++;
                document.getElementById('recognitionCount').textContent = recognitionsCount;

            } else {
                alert('Error: ' + result.error);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Error al conectar con el servidor');
        } finally {
            loadingIndicator.classList.add('hidden');
            recognizeBtn.disabled = false;
        }
    }

    // ============================================================================
    // REINICIAR (NUEVA FOTO)
    // ============================================================================
    function restart() {
        photoPanel.classList.add('hidden');
        resultPanel.classList.add('hidden');
        document.getElementById('cameraControls').classList.remove('hidden');
        capturedPhotoData = null;
        lastHandBounds = null;
        startCamera();
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    toggleCameraBtn.addEventListener('click', () => {
        if (cameraActive) stopCamera();
        else startCamera();
    });

    captureBtn.addEventListener('click', capturePhoto);
    recognizeBtn.addEventListener('click', recognizeSign);
    restartBtn.addEventListener('click', restart);
</script>

{% endblock %}